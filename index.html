<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=360, height=640, initial-scale=1, user-scalable=no">
<title></title>

<style>
* { box-sizing: border-box; font-family: Arial, Helvetica, sans-serif; }
body {
  margin: 0;
  background: #eaeaea;
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh;
}
#etm {
  width: 360px;
  height: 640px;
  background: white;
  display: flex;
  flex-direction: column;
  border: 3px solid black;
}
.screen {
  flex: 1;
  padding: 10px;
  overflow-y: auto;
}
.hidden { display: none; }

.btn {
  background: #0078d7;
  color: white;
  border: none;
  padding: 14px;
  margin: 6px 0;
  font-size: 16px;
  width: 100%;
}
.btn:active { background: #005fa3; }

input, select, textarea {
  width: 100%;
  padding: 10px;
  font-size: 16px;
  margin: 6px 0;
}

.status {
  height: 36px;
  background: black;
  color: white;
  font-size: 12px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0 8px;
}
.edit-delete-btns button {
  width: 48%;
  margin: 2px 1%;
  font-size: 14px;
  padding: 6px;
}
#tripDestinations {
  margin: 6px 0;
  padding: 10px;
  background: #f0f0f0;
  font-size: 14px;
  min-height: 40px;
}
</style>
</head>

<body>
<div id="etm">

<!-- LOGIN -->
<div id="login" class="screen">
  <h3>Driver Login</h3>
  <input id="loginUser" placeholder="Username">
  <input id="loginPin" placeholder="6-digit PIN" type="password">
  <button class="btn" onclick="login()">Log in</button>
  <button class="btn" onclick="showCreate()">Create account</button>
</div>

<!-- CREATE ACCOUNT -->
<div id="create" class="screen hidden">
  <h3>Create Account</h3>
  <input id="newEmail" placeholder="Email">
  <input id="newUser" placeholder="Username">
  <input id="newPin" placeholder="6-digit PIN" type="password">
  <button class="btn" onclick="createAccount()">Create</button>
  <button class="btn" onclick="backLogin()">Back</button>
</div>

<!-- MAIN MENU -->
<div id="menu" class="screen hidden">
  <button class="btn" onclick="showRoutes()">Routes</button>
  <button class="btn" onclick="showFleet()">Fleet</button>
  <button class="btn" onclick="showBoards()">Running Boards</button>
  <button class="btn" onclick="startTrip()">Start Trip</button>
  <button class="btn" onclick="logout()">Log out</button>
</div>

<!-- ROUTES -->
<div id="routes" class="screen hidden">
  <h3>Routes</h3>
  <input id="routeName" placeholder="Route name">
  <textarea id="routeDetails" placeholder="Route details (stops, times, notes)"></textarea>
  <button class="btn" onclick="addRoute()">Add route</button>
  <div id="routeList"></div>
  <button class="btn" onclick="backMenu()">Back</button>
</div>

<!-- FLEET -->
<div id="fleet" class="screen hidden">
  <h3>Fleet</h3>
  <input id="veh" placeholder="Vehicle / fleet number">
  <textarea id="vehDetails" placeholder="Vehicle details (type, features, capacity)"></textarea>
  <button class="btn" onclick="addVehicle()">Add vehicle</button>
  <div id="fleetList"></div>
  <button class="btn" onclick="backMenu()">Back</button>
</div>

<!-- BOARDS -->
<div id="boards" class="screen hidden">
  <h3>Running Boards</h3>
  <input id="board" placeholder="Board name">
  <textarea id="boardDetails" placeholder="Board details (start, end, notes)"></textarea>
  <button class="btn" onclick="addBoard()">Add board</button>
  <div id="boardList"></div>
  <button class="btn" onclick="backMenu()">Back</button>
</div>

<!-- TRIP -->
<div id="trip" class="screen hidden">
  <h3>Trip Active</h3>
  <select id="tripRoute" onchange="updateTripDestinations()"></select>
  <select id="tripDirection" onchange="updateTripDestinations()">
    <option value="outbound">Outbound</option>
    <option value="inbound">Inbound</option>
  </select>
  <div id="tripDestinations"></div>
  <button class="btn" onclick="sell('Cash')">Cash Ticket</button>
  <button class="btn" onclick="sell('Card')">Card Ticket</button>
  <button class="btn" onclick="endTrip()">End Trip</button>
</div>

<!-- STATUS BAR -->
<div class="status">
  <span>WiFi ●●●</span>
  <span>Paper ███</span>
  <span id="clock"></span>
</div>

</div>

<script>
let currentUser = null;

// Preload admin
function initData() {
  const d = JSON.parse(localStorage.getItem("etmUsers") || "{}");
  if(!d["owen24615"]) {
    d["owen24615"] = { email:"admin@example.com", pin:"889448", routes:[], fleet:[], boards:[] };
    localStorage.setItem("etmUsers", JSON.stringify(d));
  }
}
initData();

function getData() { return JSON.parse(localStorage.getItem("etmUsers") || "{}"); }
function saveData(d) { localStorage.setItem("etmUsers", JSON.stringify(d)); }

function login() {
  const u = loginUser.value;
  const p = loginPin.value;
  const d = getData();
  if (d[u] && d[u].pin === p) {
    currentUser = u;
    show("menu");
  } else alert("Invalid login");
}

function createAccount() {
  const d = getData();
  const u = newUser.value;
  if (d[u]) return alert("User exists");
  d[u] = { email: newEmail.value, pin: newPin.value, routes: [], fleet: [], boards: [] };
  saveData(d);
  alert("Account created");
  backLogin();
}

function logout() { currentUser=null; show("login"); }

function addRoute() {
  const d = getData();
  d[currentUser].routes.push({ name: routeName.value, details: routeDetails.value });
  saveData(d); render();
}
function addVehicle() {
  const d = getData();
  d[currentUser].fleet.push({ name: veh.value, details: vehDetails.value });
  saveData(d); render();
}
function addBoard() {
  const d = getData();
  d[currentUser].boards.push({ name: board.value, details: boardDetails.value });
  saveData(d); render();
}

function editItem(type, index) {
  const d = getData();
  const item = d[currentUser][type][index];
  const newName = prompt("Edit name:", item.name);
  if(newName===null) return;
  const newDetails = prompt("Edit details:", item.details);
  if(newDetails===null) return;
  item.name = newName;
  item.details = newDetails;
  saveData(d); render();
}

function deleteItem(type, index) {
  const d = getData();
  if(confirm("Delete this item?")) {
    d[currentUser][type].splice(index,1);
    saveData(d); render();
  }
}

function startTrip() {
  show("trip");
  const d = getData()[currentUser];
  const tripRoute = document.getElementById("tripRoute");
  tripRoute.innerHTML = "";
  d.routes.forEach(r=>{
    const opt = document.createElement("option");
    opt.value = r.name;
    opt.textContent = r.name;
    tripRoute.appendChild(opt);
  });
  updateTripDestinations();
}

function updateTripDestinations() {
  const d = getData()[currentUser];
  const routeName = tripRoute.value;
  const direction = tripDirection.value;
  const route = d.routes.find(r=>r.name===routeName);
  if(route) {
    // Show either the full details or the section containing "Outbound"/"Inbound"
    let text = route.details;
    const regex = new RegExp(direction+"[:\\s]*(.*)", "i");
    const match = text.match(regex);
    document.getElementById("tripDestinations").textContent = match ? match[1] : text;
  } else {
    document.getElementById("tripDestinations").textContent = "";
  }
}

function endTrip() { show("menu"); }
function sell(t){ alert(t+" ticket issued"); }

function render() {
  const d = getData()[currentUser];
  routeList.innerHTML = d.routes.map((r,i)=>`${r.name}: ${r.details}<div class="edit-delete-btns"><button onclick="editItem('routes',${i})">Edit</button><button onclick="deleteItem('routes',${i})">Delete</button></div>`).join("<br>");
  fleetList.innerHTML = d.fleet.map((v,i)=>`${v.name}: ${v.details}<div class="edit-delete-btns"><button onclick="editItem('fleet',${i})">Edit</button><button onclick="deleteItem('fleet',${i})">Delete</button></div>`).join("<br>");
  boardList.innerHTML = d.boards.map((b,i)=>`${b.name}: ${b.details}<div class="edit-delete-btns"><button onclick="editItem('boards',${i})">Edit</button><button onclick="deleteItem('boards',${i})">Delete</button></div>`).join("<br>");
  updateTripDestinations();
}

function show(id){
  document.querySelectorAll(".screen").forEach(s=>s.classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");
  if(currentUser) render();
}
function showRoutes(){show("routes")}
function showFleet(){show("fleet")}
function showBoards(){show("boards")}
function backMenu(){show("menu")}
function showCreate(){show("create")}
function backLogin(){show("login")}

setInterval(()=>{
  const d=new Date();
  clock.textContent=d.toLocaleTimeString()+" "+d.toLocaleDateString();
},1000);
</script>
</body>
</html>
