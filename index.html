<!DOCTYPE html>
<html lang="en-GB">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<style>
body{
  margin:0;
  font-family:system-ui,-apple-system;
  background:#f0f0f0;
  display:flex;
  justify-content:center;
  align-items:center;
  min-height:100vh;
}
.machine{
  width:400px;
  height:90vh;
  background:#fff;
  border-radius:12px;
  box-shadow:0 8px 30px rgba(0,0,0,.4);
  display:flex;
  flex-direction:column;
  overflow:hidden;
}
.screen{
  flex:1;
  padding:12px;
  font-family:monospace;
  white-space:pre-line;
  overflow:auto;
}
.buttons{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:8px;
  padding:10px;
}
button{
  padding:18px 0;
  font-size:16px;
  font-weight:700;
  border:none;
  border-radius:6px;
}
.blue{background:#0076c8;color:#fff;}
.green{background:#27ae60;color:#fff;}
.red{background:#c0392b;color:#fff;}
.gray{background:#ccc;}
.admin{background:#8e44ad;color:#fff;}
.hidden{display:none;}

.bottom-bar{
  background:#000;
  color:#fff;
  font-size:14px;
  padding:4px 12px;
  display:flex;
  justify-content:space-between;
}
</style>
</head>

<body>

<div class="machine">

  <div class="screen" id="screen">ENTER 6-DIGIT PIN</div>

  <!-- LOGIN -->
  <div class="buttons" id="loginPad">
    <button onclick="num(1)">1</button><button onclick="num(2)">2</button><button onclick="num(3)">3</button>
    <button onclick="num(4)">4</button><button onclick="num(5)">5</button><button onclick="num(6)">6</button>
    <button onclick="num(7)">7</button><button onclick="num(8)">8</button><button onclick="num(9)">9</button>
    <button class="red" onclick="clearPin()">CLR</button>
    <button onclick="num(0)">0</button>
    <button class="blue" onclick="login()">ENT</button>
  </div>

  <!-- MAIN -->
  <div class="buttons hidden" id="mainPad">
    <button class="green" onclick="startTrip()">START</button>
    <button class="red" onclick="endTrip()">END</button>
    <button class="blue" onclick="pickRoute()">ROUTE</button>
    <button class="blue" onclick="sell('cash')">CASH</button>
    <button class="blue" onclick="sell('card')">CARD</button>
    <button class="gray" onclick="companyMenu()">COMPANY</button>
    <button class="gray" onclick="logout()">LOG OUT</button>

    <button class="admin hidden" id="adminView" onclick="adminView()">VIEW</button>
    <button class="admin hidden" id="adminBack" onclick="adminBack()">BACK</button>
  </div>

  <div class="bottom-bar">
    <span>ðŸ“¶ WiFi âœ” | ðŸ§¾ Paper âœ”</span>
    <span id="time"></span>
  </div>

</div>

<script>
/* ===== DATA ===== */
const ADMIN_PIN="889448";
let db=JSON.parse(localStorage.getItem("db")||"{}");
let pin="",logged=null,viewing=null;
let activeCompany=null,currentRoute=null,trip=false;

const screen=document.getElementById("screen");

/* ===== HELPERS ===== */
function save(){localStorage.setItem("db",JSON.stringify(db));}
function show(txt){screen.textContent=txt;}

/* ===== KEYPAD ===== */
function num(n){ if(pin.length<6){pin+=n; show("PIN: "+pin);} }
function clearPin(){ pin=""; show("ENTER 6-DIGIT PIN"); }

/* ===== LOGIN / ACCOUNT ===== */
function login(){
  if(pin.length!==6) return;

  if(!db[pin]){
    if(pin===ADMIN_PIN){
      db[pin]={name:"ADMIN",email:"",companies:[],totals:{cash:0,card:0},messages:[]};
    }else{
      const email=prompt("Email:");
      const name=prompt("Username:");
      if(!email||!name){clearPin();return;}
      db[pin]={name,email,companies:[],totals:{cash:0,card:0},messages:[]};
    }
    save();
  }

  logged=pin;
  viewing=pin;
  pin="";
  loginPad.classList.add("hidden");
  mainPad.classList.remove("hidden");

  if(logged===ADMIN_PIN){
    adminViewBtn(true);
  }
  dashboard();
}

/* ===== DASHBOARD ===== */
function dashboard(){
  const u=db[viewing];
  show(
`USER: ${u.name}
TRIP: ${trip?"ACTIVE":"STOPPED"}
COMPANY: ${activeCompany?activeCompany.name:"NONE"}
ROUTE: ${currentRoute||"NONE"}

CASH: Â£${u.totals.cash.toFixed(2)}
CARD: Â£${u.totals.card.toFixed(2)}`
  );
}

/* ===== COMPANY ===== */
function companyMenu(){
  const u=db[logged];
  let list=u.companies.map((c,i)=>`${i+1}. ${c.name}`).join("\n");
  let c=prompt(`COMPANIES:\n${list}\n\nEnter number or NEW`);
  if(c==="NEW"){
    if(u.companies.length>=30) return alert("MAX 30");
    let name=prompt("Company name:");
    let comp={name,routes:[],fleet:[],boards:[]};
    u.companies.push(comp);
    activeCompany=comp;
  }else{
    let idx=parseInt(c)-1;
    if(!u.companies[idx]) return;
    activeCompany=u.companies[idx];
  }
  save(); dashboard();
}

/* ===== ROUTES ===== */
function pickRoute(){
  if(!activeCompany) return alert("SELECT COMPANY");
  let list=activeCompany.routes.map((r,i)=>`${i+1}. ${r.code}`).join("\n");
  let r=prompt(`ROUTES:\n${list}\n\nEnter number or NEW`);
  if(r==="NEW"){
    let code=prompt("Route code:");
    let fare=parseFloat(prompt("Fare:",2));
    activeCompany.routes.push({code,fare});
    currentRoute=code;
  }else{
    let idx=parseInt(r)-1;
    if(!activeCompany.routes[idx]) return;
    currentRoute=activeCompany.routes[idx].code;
  }
  save(); dashboard();
}

/* ===== TRIPS ===== */
function startTrip(){ if(!currentRoute) return alert("SELECT ROUTE"); trip=true; dashboard(); }
function endTrip(){ trip=false; currentRoute=null; dashboard(); }

/* ===== SALES ===== */
function sell(type){
  if(!trip) return alert("START TRIP");
  db[viewing].totals[type]+=2;
  save(); dashboard();
}

/* ===== ADMIN ===== */
function adminViewBtn(showBtn){
  document.getElementById("adminView").classList.toggle("hidden",!showBtn);
  document.getElementById("adminBack").classList.toggle("hidden",!showBtn);
}
function adminView(){
  let p=prompt("Driver PIN");
  if(!db[p]) return;
  viewing=p; dashboard();
}
function adminBack(){ viewing=logged; dashboard(); }

/* ===== LOGOUT ===== */
function logout(){ location.reload(); }

/* ===== TIME ===== */
function tick(){
  time.textContent=new Date().toLocaleTimeString("en-GB",{hour12:false});
}
setInterval(tick,1000); tick();
</script>

</body>
</html>
